name: Auto review PRs

on:
  pull_request:
    types: [opened]

jobs:
  auto-review:
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Auto review PR
        id: claude-review
        uses: anthropics/claude-code-action@beta
        continue-on-error: true  # Prevent API failures from blocking PR workflow
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: "claude-sonnet-4-20250514"
          max_tokens: 4096
          direct_prompt: |
            Please review this PR. Look at the changes and provide thoughtful feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage
            - Suggestions for improvements
            - Overall architecture and design decisions

            Be constructive and specific in your feedback. Give inline comments where applicable.
            Focus on the most important issues and be concise to stay within token limits.
          allowed_tools: "Bash(npm run test),Bash(npm run lint),Bash(npm run typecheck)"

      - name: Report Review Status
        if: always()
        run: |
          if [ "${{ steps.claude-review.outcome }}" = "failure" ]; then
            echo "‚ö†Ô∏è Claude code review failed"
            echo "üìã The PR can still be merged manually after human review"
            echo "üîç Possible issues:"
            echo "  - Claude API rate limits or quota exceeded"
            echo "  - Large PR exceeding token limits"
            echo "  - Network or service issues"
            echo "üí° Consider breaking large PRs into smaller chunks"
          elif [ "${{ steps.claude-review.outcome }}" = "success" ]; then
            echo "‚úÖ Claude code review completed successfully"
            echo "üìù Review comments should be visible in the PR"
          else
            echo "‚è≠Ô∏è Claude code review was skipped"
          fi